# RBS to Diagram

## ドメインモデリング

### 主要ドメインオブジェクト

#### RBS
##### RBSFile
- 責務: RBSファイルの内容を表現し、ファイルパスと内容を管理する
- 振る舞い: ファイル読み込み、構文検証、AST生成の起点となる

##### SyntaxTree
- 責務: RBSファイルの構文解析結果を木構造として保持する
- 振る舞い: ノード探索、構造情報の抽出、型情報の取得

##### Definition
- 責務: RBS内の定義情報（クラス・モジュール）を統一的に表現し、関係性を管理する
- 振る舞い: 継承・インクルード関係の取得、メソッド一覧の提供、依存関係の特定
- 具象化: ClassDefinition（クラス定義）、ModuleDefinition（モジュール定義）

##### RBSParserResult
- 責務: RBS解析の結果を集約し、図生成に必要な情報を提供する
- 振る舞い: Definition集合の管理、依存関係の分析、図生成の起点となる

### Diagram
**DiagramFormatter（図フォーマッター）**
- 責務: RBS情報を図形式（現在はMermaid.js）に変換する
- 振る舞い: 図の構築、フォーマット変換、出力処理

## プロジェクト概要

このプロジェクトは、RubyのRBS（Ruby Signature）ファイルを解析して、Mermaid.js形式の図を自動生成するCLIツールです。RBSファイルに定義された型情報、クラス構造、モジュール関係を視覚的な図として出力することで、Rubyプロジェクトの設計理解とドキュメント作成を支援します。

## 基本機能

### 1. RBSファイル解析機能
指定されたRBSファイルまたはディレクトリを解析し、クラス、モジュール、メソッド、型定義などの構造情報を抽出します。RBSの構文を正確にパースし、型情報や継承関係、インクルード・エクステンド関係を識別して内部データ構造として保持します。

### 2. MermaidJSファイル出力機能
解析したRBS情報をMermaid.js形式の図として出力します。クラス図やモジュール依存関係図を生成し、指定されたファイルパスに保存するか、標準出力に表示します。出力される図は、RBSで定義された構造を視覚的に理解しやすい形で表現します。

## データ構造設計

### メモリ内データ構造

#### RBSファイル情報
```ruby
# ファイル情報の保持
{
  file_path: String,     # ファイルパス
  content: String,       # ファイル内容
  encoding: String       # 文字エンコーディング
}
```

#### 解析結果データ
```ruby
# RBSParserResult内部構造
{
  definitions: Array[Definition],  # 定義情報の配列
  file_info: Hash,                # ファイル情報
  parsed_at: Time                 # 解析実行時刻
}
```

#### 定義情報データ
```ruby
# Definition共通構造
{
  name: String,           # 定義名
  type: Symbol,          # :class または :module
  methods: Array[String], # メソッド一覧
  visibility: Symbol     # :public, :private
}
```

## ファイルシステム設計

### ディレクトリ構造
```
current_directory/
├── target.rbs         # 解析対象のRBSファイル（固定）
└── rbs_parse_single   # 実行スクリプト（想定）
```

### ファイル操作パターン
1. **ファイル確認**: `target.rbs` の存在確認
2. **読み込み**: `File.read('target.rbs', encoding: 'UTF-8')` でファイル内容を取得
3. **出力**: `puts` で標準出力に結果を出力

## データフロー

### 処理フロー
1. **ファイル検索** → RBSファイルパスの取得
2. **ファイル読み込み** → RBSFile オブジェクトの生成
3. **構文解析** → RBSParserResult オブジェクトの生成
4. **テキスト変換** → Formatter による構造化テキストの生成
5. **標準出力** → 結果の表示

### データ変換フロー
```
RBSファイル（テキスト）
    ↓
RBSFile（オブジェクト）
    ↓
RBSParserResult（解析結果）
    ↓
構造化テキスト（String）
    ↓
標準出力（表示）
```

## エラーハンドリング戦略

### エラー分類
1. **ファイルシステムエラー**
   - ファイル不存在
   - 読み取り権限なし
   - ディスクI/Oエラー

2. **RBS構文エラー**
   - 構文解析失敗
   - 型定義エラー
   - 不正なRBS記法

3. **システムエラー**
   - メモリ不足
   - 予期しない例外

### エラー処理方針
- **最小限のエラーハンドリング**: 詳細なエラー分類は行わない
- **即座に終了**: エラー発生時は処理を中断し、終了コード1で終了
- **エラーメッセージ**: 標準エラー出力に最小限のメッセージを出力

## パフォーマンス考慮事項

### メモリ使用量
- **ファイルサイズ制限**: 特に設けない（一般的なRBSファイルサイズを想定）
- **メモリ効率**: ファイル内容を一度にメモリに読み込む方式
- **ガベージコレクション**: Rubyの自動ガベージコレクションに依存

### 処理速度
- **ファイル検索**: `Dir.glob` を使用した効率的な検索
- **解析処理**: RBSライブラリの標準的な解析速度に依存
- **出力処理**: 標準出力への直接書き込み

## データ整合性制約

### 入力データ制約
- **ファイル存在**: 処理対象のRBSファイルが存在すること
- **読み取り可能**: ファイルに読み取り権限があること
- **有効なRBS**: RBS構文として正しいこと

### 出力データ制約
- **完全性**: 解析に成功した場合、すべての定義情報を出力すること
- **一貫性**: 出力形式が仕様に従っていること
- **可読性**: 人間が理解できる形式であること

### データ変換制約
- **情報の保持**: RBS定義の情報を欠損なく変換すること
- **型情報の正確性**: メソッドシグネチャの型情報を正確に表現すること
- **階層構造の維持**: クラス・モジュールの構造を適切に表現すること

## ファイルアクセス権限設計

### アクセス権限方針
- **読み取り専用**: RBSファイルは読み取りのみ
- **書き込み不要**: ファイルシステムへの書き込みは行わない
- **一時ファイル不使用**: 中間ファイルの作成は行わない

